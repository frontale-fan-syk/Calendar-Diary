<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã•ã‚„ã‹ã•ã‚“ã®ä¸‡å¹´æ—¥è¨˜å¸³</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; background: #fdf6f0; color: #444; padding-bottom: 50px; margin: 0; }
        .calendar-header { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 15px 0; width: 100%; }
        .nav-btn { background: #d88a8a; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; }
        h2 { color: #d88a8a; margin: 0; font-size: 1.2rem; text-align: center; }
        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; max-width: 450px; width: 92%; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .weekday { text-align: center; font-size: 12px; font-weight: bold; color: #999; padding: 5px 0; }
        .day { aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; border: 1px solid #f0f0f0; background: #fff; position: relative; }
        /* æ—¥æ›œãƒ»ç¥æ—¥ã¯èµ¤ */
        .sun, .holiday { color: #ff4d4d !important; background: #fff5f5; }
        /* åœŸæ›œæ—¥ã¯é’ */
        .sat { color: #4d79ff; background: #f5f7ff; }
        .today { border: 2px solid #d88a8a !important; font-weight: bold; }
        .selected { background: #fff0f0; border: 2px solid #d88a8a !important; }
        .mark-any { width: 5px; height: 5px; background: #d88a8a; border-radius: 50%; margin-top: 2px; }
        #editor-area { margin-top: 20px; width: 92%; max-width: 450px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); box-sizing: border-box; }
        select, textarea { width: 100%; border-radius: 8px; border: 1px solid #ddd; padding: 12px; box-sizing: border-box; font-size: 16px; margin-bottom: 15px; background-color: #fcfcfc; }
        textarea { height: 100px; resize: none; }
        .save-btn { background: #d88a8a; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 18px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        .backup-btn { background: #888; color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; font-size: 14px; cursor: pointer; }
        .section-title { width: 92%; max-width: 450px; color: #d88a8a; margin-top: 30px; }
        .filter-group { display: flex; gap: 8px; width: 92%; max-width: 450px; margin-bottom: 15px; }
        .list-container { width: 92%; max-width: 450px; min-height: 50px; }
        .history-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-left: 5px solid #d88a8a; position: relative; }
        .history-header { display: flex; flex-direction: column; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; }
        .history-date { font-weight: bold; font-size: 14px; color: #d88a8a; }
        .history-content { font-size: 15px; white-space: pre-wrap; line-height: 1.5; }
        .delete-btn { position: absolute; top: 12px; right: 12px; background: none; border: none; color: #ddd; cursor: pointer; font-size: 22px; }
    </style>
</head>
<body>
    <div class="calendar-header">
        <button class="nav-btn" id="prev-btn">â—€</button>
        <h2 id="currentMonthYear">èª­ã¿è¾¼ã¿ä¸­...</h2>
        <button class="nav-btn" id="next-btn">â–¶</button>
    </div>
    <div id="calendar"></div>
    <div id="editor-area">
        <h3 id="selected-date-label" style="margin-top:0; font-size: 18px;">æ—¥ä»˜ã‚’é¸æŠ</h3>
        <label>äºˆå®š</label>
        <select id="event-input">
            <option value="">ãªã—</option>
            <option value="è©¦åˆæ—¥">âš½ è©¦åˆæ—¥</option>
            <option value="ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°">ğŸ‘‚ ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°</option>
            <option value="å­¦æ ¡è¨ªå•">ğŸ« å­¦æ ¡è¨ªå•</option>
        </select>
        <label>æ°—åˆ†</label>
        <select id="category-input">
            <option value="">ãªã—</option>
            <option value="ğŸ˜Š å–œ">ğŸ˜Š å–œ</option>
            <option value="ğŸ‰ æ¥½">ğŸ‰ æ¥½</option>
            <option value="ğŸ˜¢ å“€">ğŸ˜¢ å“€</option>
            <option value="ğŸ’¢ æ€’">ğŸ’¢ æ€’</option>
        </select>
        <textarea id="diary-input" placeholder="å†…å®¹ã‚’å…¥åŠ›..."></textarea>
        <button class="save-btn" id="save-btn">åŒæœŸä¿å­˜ã™ã‚‹</button>
        <button class="backup-btn" id="backup-btn">ğŸ“¥ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜(ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)</button>
    </div>
    <div class="section-title"><h3>ğŸ” æŒ¯ã‚Šè¿”ã‚Š</h3></div>
    <div class="filter-group">
        <select id="filter-event">
            <option value="all">ã™ã¹ã¦ã®äºˆå®š</option>
            <option value="è©¦åˆæ—¥">âš½ è©¦åˆæ—¥</option>
            <option value="ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°">ğŸ‘‚ ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°</option>
            <option value="å­¦æ ¡è¨ªå•">ğŸ« å­¦æ ¡è¨ªå•</option>
        </select>
        <select id="filter-mood">
            <option value="all">ã™ã¹ã¦ã®æ°—åˆ†</option>
            <option value="ğŸ˜Š å–œ">ğŸ˜Š å–œ</option>
            <option value="ğŸ‰ æ¥½">ğŸ‰ æ¥½</option>
            <option value="ğŸ˜¢ å“€">ğŸ˜¢ å“€</option>
            <option value="ğŸ’¢ æ€’">ğŸ’¢ æ€’</option>
        </select>
    </div>
    <div id="history-list" class="list-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKTYQlERzcbsLWng8Y6E3yKcuK8kn0r7U",
            authDomain: "sayaka-diary.firebaseapp.com",
            projectId: "sayaka-diary",
            storageBucket: "sayaka-diary.firebasestorage.app",
            messagingSenderId: "1095135376250",
            appId: "1:1095135376250:web:5301396cba61e67bbfdcc3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentViewDate = new Date();
        let selectedDateStr = "";
        const holidays2026 = {
            "01-01":"å…ƒæ—¥", "01-12":"æˆäººã®æ—¥", "02-11":"å»ºå›½è¨˜å¿µã®æ—¥", "02-23":"å¤©çš‡èª•ç”Ÿæ—¥", "03-20":"æ˜¥åˆ†ã®æ—¥", "04-29":"æ˜­å’Œã®æ—¥",
            "05-03":"æ†²æ³•è¨˜å¿µæ—¥", "05-04":"ã¿ã©ã‚Šã®æ—¥", "05-05":"ã“ã©ã‚‚ã®æ—¥", "05-06":"æŒ¯æ›¿ä¼‘æ—¥", "07-20":"æµ·ã®æ—¥", "08-11":"å±±ã®æ—¥",
            "09-21":"æ•¬è€ã®æ—¥", "09-22":"å›½æ°‘ã®ä¼‘æ—¥", "09-23":"ç§‹åˆ†ã®æ—¥", "10-12":"ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "11-03":"æ–‡åŒ–ã®æ—¥", "11-23":"å‹¤åŠ´æ„Ÿè¬ã®æ—¥"
        };

        async function renderView() {
            const calendarEl = document.getElementById('calendar');
            const historyListEl = document.getElementById('history-list');
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            document.getElementById('currentMonthYear').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            
            calendarEl.innerHTML = '<div class="weekday sun">æ—¥</div><div class="weekday">æœˆ</div><div class="weekday">ç«</div><div class="weekday">æ°´</div><div class="weekday">æœ¨</div><div class="weekday">é‡‘</div><div class="weekday sat">åœŸ</div>';
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { calendarEl.innerHTML += '<div></div>'; }

            let allMonthlyItems = [];
            const querySnapshot = await getDocs(collection(db, "diaries"));
            querySnapshot.forEach((doc) => {
                const dateKey = doc.id;
                if (dateKey.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)) {
                    const items = doc.data().items || [];
                    items.forEach((item, idx) => { allMonthlyItems.push({ date: dateKey, index: idx, ...item }); });
                }
            });

            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                if (dateStr === selectedDateStr) dayDiv.classList.add('selected');
                dayDiv.innerText = d;
                const dayOfWeek = new Date(year, month, d).getDay();
                if (dayOfWeek === 0) dayDiv.classList.add('sun');
                if (dayOfWeek === 6) dayDiv.classList.add('sat');
                if (year === 2026 && holidays2026[dateStr.slice(5)]) dayDiv.classList.add('holiday');
                const todayStr = new Date().toISOString().split('T')[0];
                if (dateStr === todayStr) dayDiv.classList.add('today');
                if (allMonthlyItems.some(item => item.date === dateStr)) {
                    dayDiv.innerHTML += '<div class="mark-container"><div class="mark-any"></div></div>';
                }
                dayDiv.onclick = () => { selectedDateStr = dateStr; document.getElementById('selected-date-label').innerText = `${month + 1
