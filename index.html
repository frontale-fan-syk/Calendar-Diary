<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã•ã‚„ã‹ã•ã‚“ã®ä¸‡å¹´æ—¥è¨˜å¸³</title>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; background: #fdf6f0; color: #444; padding-bottom: 50px; margin: 0; }
        .calendar-header { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 15px 0; width: 100%; }
        .nav-btn { background: #d88a8a; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; }
        h2 { color: #d88a8a; margin: 0; font-size: 1.2rem; text-align: center; }
        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; max-width: 450px; width: 92%; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .weekday { text-align: center; font-size: 12px; font-weight: bold; color: #999; padding: 5px 0; }
        .day { aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; border: 1px solid #f0f0f0; background: #fff; position: relative; min-height: 50px; }
        /* åœŸæ—¥ã¯é’ã¨èµ¤ */
        .sun, .holiday { color: #ff4d4d !important; background: #fff5f5; }
        .sat { color: #4d79ff; background: #f5f7ff; }
        .today { border: 2px solid #d88a8a !important; font-weight: bold; }
        .selected { background: #fff0f0; border: 2px solid #d88a8a !important; }
        .mark-any { width: 6px; height: 6px; background: #d88a8a; border-radius: 50%; margin-top: 2px; }
        #editor-area { margin-top: 20px; width: 92%; max-width: 450px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); box-sizing: border-box; }
        select, textarea { width: 100%; border-radius: 8px; border: 1px solid #ddd; padding: 12px; box-sizing: border-box; font-size: 16px; margin-bottom: 15px; background-color: #fcfcfc; }
        textarea { height: 100px; resize: none; }
        .save-btn { background: #d88a8a; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; }
        .backup-btn { background: #888; color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; font-size: 14px; cursor: pointer; margin-top: 10px; }
        .section-title { width: 92%; max-width: 450px; color: #d88a8a; margin-top: 30px; }
        .list-container { width: 92%; max-width: 450px; }
        .history-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-left: 5px solid #d88a8a; position: relative; }
        /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ */
        #debug-log { width: 92%; color: red; font-size: 12px; margin: 10px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="debug-log"></div>
    <div class="calendar-header">
        <button class="nav-btn" id="prev-btn">â—€</button>
        <h2 id="currentMonthYear">èª­ã¿è¾¼ã¿ä¸­...</h2>
        <button class="nav-btn" id="next-btn">â–¶</button>
    </div>
    <div id="calendar"></div>
    <div id="editor-area">
        <h3 id="selected-date-label">æ—¥ä»˜ã‚’é¸æŠã—ã¦ã­</h3>
        <select id="event-input"><option value="">äºˆå®šãªã—</option><option value="è©¦åˆæ—¥">âš½ è©¦åˆæ—¥</option><option value="ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°">ğŸ‘‚ ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°</option></select>
        <select id="category-input"><option value="">æ°—åˆ†ãªã—</option><option value="ğŸ˜Š å–œ">ğŸ˜Š å–œ</option><option value="ğŸ‰ æ¥½">ğŸ‰ æ¥½</option></select>
        <textarea id="diary-input" placeholder="å†…å®¹ã‚’å…¥åŠ›..."></textarea>
        <button class="save-btn" id="save-btn">åŒæœŸä¿å­˜ã™ã‚‹</button>
        <button class="backup-btn" id="backup-btn">ğŸ“¥ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜(ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)</button>
    </div>
    <div class="section-title"><h3>ğŸ” æŒ¯ã‚Šè¿”ã‚Š</h3></div>
    <div id="history-list" class="list-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ã€ã“ã“ã‚’è‡ªåˆ†ã®Firebaseè¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼ã€‘
        const firebaseConfig = {
          apiKey: "AIzaSyCKTYQlERzcbsLWng8Y6E3yKcuK8kn0r7U",
          authDomain: "sayaka-diary.firebaseapp.com",
          projectId: "sayaka-diary",
          storageBucket: "sayaka-diary.firebasestorage.app",
          messagingSenderId: "1095135376250",
          appId: "1:1095135376250:web:5301396cba61e67bbfdcc3"
        };

        function logError(msg) { document.getElementById('debug-log').innerText += msg + "\n"; }

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) { logError("Firebaseæ¥ç¶šå¤±æ•—: " + e.message); }

        let currentViewDate = new Date();
        let selectedDateStr = "";

        async function renderView() {
            try {
                const year = currentViewDate.getFullYear();
                const month = currentViewDate.getMonth();
                const monthStr = String(month + 1).padStart(2, '0');
                document.getElementById('currentMonthYear').innerText = `${year}å¹´ ${month + 1}æœˆ`;

                const calendarEl = document.getElementById('calendar');
                calendarEl.innerHTML = '<div class="weekday sun">æ—¥</div><div class="weekday">æœˆ</div><div class="weekday">ç«</div><div class="weekday">æ°´</div><div class="weekday">æœ¨</div><div class="weekday">é‡‘</div><div class="weekday sat">åœŸ</div>';

                // 1. ã¾ãšã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ ã ã‘æç”»
                const firstDay = new Date(year, month, 1).getDay();
                const lastDate = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDay; i++) { calendarEl.innerHTML += '<div></div>'; }

                for (let d = 1; d <= lastDate; d++) {
                    const dateStr = `${year}-${monthStr}-${String(d).padStart(2, '0')}`;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'day';
                    dayDiv.id = "day-" + dateStr;
                    dayDiv.innerText = d;
                    const dayOfWeek = new Date(year, month, d).getDay();
                    if (dayOfWeek === 0) dayDiv.classList.add('sun');
                    if (dayOfWeek === 6) dayDiv.classList.add('sat');
                    if (dateStr === selectedDateStr) dayDiv.classList.add('selected');
                    dayDiv.onclick = () => { selectedDateStr = dateStr; renderView(); };
                    calendarEl.appendChild(dayDiv);
                }

                // 2. ãã®ã‚ã¨ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãã¦ãƒãƒ¼ã‚¯ã‚’ä»˜ã‘ã‚‹
                const historyListEl = document.getElementById('history-list');
                historyListEl.innerHTML = "";
                
                const querySnapshot = await getDocs(collection(db, "diaries"));
                querySnapshot.forEach((docSnap) => {
                    const dateKey = docSnap.id;
                    const items = docSnap.data().items || [];
                    if (items.length > 0 && dateKey.startsWith(`${year}-${monthStr}`)) {
                        const targetDay = document.getElementById("day-" + dateKey);
                        if (targetDay) targetDay.innerHTML += '<div class="mark-any"></div>';
                        
                        items.forEach((item, idx) => {
                            const div = document.createElement('div');
                            div.className = 'history-item';
                            div.innerHTML = `<strong>${dateKey} ${item.category || ''}</strong><br>${item.text}`;
                            historyListEl.appendChild(div);
                        });
                    }
                });
            } catch (e) { logError("æç”»ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        // ãƒœã‚¿ãƒ³ã®è¨­å®š
        document.getElementById('prev-btn').onclick = () => { currentViewDate.setMonth(currentViewDate.getMonth() - 1); renderView(); };
        document.getElementById('next-btn').onclick = () => { currentViewDate.setMonth(currentViewDate.getMonth() + 1); renderView(); };
        document.getElementById('save-btn').onclick = async () => {
            const text = document.getElementById('diary-input').value;
            if(!selectedDateStr || !text) return alert("æ—¥ä»˜é¸æŠã¨å…¥åŠ›ã‚’ã—ã¦ã­");
            const docRef = doc(db, "diaries", selectedDateStr);
            const snap = await getDoc(docRef);
            let items = snap.exists() ? snap.data().items : [];
            items.push({ text: text, category: document.getElementById('category-input').value });
            await setDoc(docRef, { items: items });
            document.getElementById('diary-input').value = "";
            renderView();
        };

        renderView();
    </script>
</body>
</html>
