<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>さやかさんの万年日記帳 (完成版)</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKTYQlERzcbsLWng8Y6E3yKcuK8kn0r7U",
            authDomain: "sayaka-diary.firebaseapp.com",
            projectId: "sayaka-diary",
            storageBucket: "sayaka-diary.firebasestorage.app",
            messagingSenderId: "1095135376250",
            appId: "1:1095135376250:web:5301396cba61e67bbfdcc3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentViewDate = new Date();
        let selectedDateStr = "";
        
        const holidays2026 = {
            "01-01":"元日", "01-12":"成人の日", "02-11":"建国記念の日", "02-23":"天皇誕生日", "03-20":"春分の日", "04-29":"昭和の日",
            "05-03":"憲法記念日", "05-04":"みどりの日", "05-05":"こどもの日", "05-06":"振替休日", "07-20":"海の日", "08-11":"山の日",
            "09-21":"敬老の日", "09-22":"国民の休日", "09-23":"秋分の日", "10-12":"スポーツの日", "11-03":"文化の日", "11-23":"勤労感謝の日"
        };

        async function renderView() {
            const calendarEl = document.getElementById('calendar');
            const historyListEl = document.getElementById('history-list');
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            
            document.getElementById('currentMonthYear').innerText = `${year}年 ${month + 1}月`;
            calendarEl.innerHTML = '<div class="weekday sun">日</div><div class="weekday">月</div><div class="weekday">火</div><div class="weekday">水</div><div class="weekday">木</div><div class="weekday">金</div><div class="weekday sat">土</div>';
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                calendarEl.innerHTML += '<div></div>';
            }

            let allMonthlyItems = [];

            // 今表示している月の全データを取得
            const querySnapshot = await getDocs(collection(db, "diaries"));
            querySnapshot.forEach((doc) => {
                const dateKey = doc.id; // "2026-02-22"
                if (dateKey.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)) {
                    const items = doc.data().items || [];
                    items.forEach((item, idx) => {
                        allMonthlyItems.push({ date: dateKey, index: idx, ...item });
                    });
                }
            });

            // カレンダー描画
            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                if (dateStr === selectedDateStr) dayDiv.classList.add('selected');
                dayDiv.innerText = d;

                const dayOfWeek = new Date(year, month, d).getDay();
                if (dayOfWeek === 0) dayDiv.classList.add('sun');
                if (dayOfWeek === 6) dayDiv.classList.add('sat');
                if (year === 2026 && holidays2026[dateStr.slice(5)]) dayDiv.classList.add('holiday');
                
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                if (dateStr === todayStr) dayDiv.classList.add('today');

                // この日にデータがあるかチェック
                if (allMonthlyItems.some(item => item.date === dateStr)) {
                    dayDiv.innerHTML += '<div class="mark-container"><div class="mark-any"></div></div>';
                }

                dayDiv.onclick = () => {
                    selectedDateStr = dateStr;
                    document.getElementById('selected-date-label').innerText = `${month + 1}月 ${d}日の記録を追加`;
                    renderView();
                };
                calendarEl.appendChild(dayDiv);
            }

            // 履歴（振り返り）の表示
            historyListEl.innerHTML = '';
            const fEvent = document.getElementById('filter-event').value;
            const fMood = document.getElementById('filter-mood').value;
            
            allMonthlyItems.sort((a, b) => b.date.localeCompare(a.date));
            allMonthlyItems.forEach(item => {
                const matchEvent = (fEvent === 'all' || item.event === fEvent);
                const matchMood = (fMood === 'all' || item.category === fMood);
                
                if (matchEvent && matchMood) {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <button class="delete-btn" onclick="deleteItem('${item.date}', ${item.index})">×</button>
                        <div class="history-header">
                            <span class="history-date">${item.date} ${item.category || ''}</span>
                            <span class="history-event">${item.event ? '【'+item.event+'】' : ''}</span>
                        </div>
                        <div class="history-content">${item.text}</div>`;
                    historyListEl.appendChild(div);
                }
            });
        }

        async function downloadBackup() {
            const querySnapshot = await getDocs(collection(db, "diaries"));
            let backupData = {};
            querySnapshot.forEach((doc) => { backupData[doc.id] = doc.data(); });
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diary_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('バックアップを保存しました！');
        }

        async function saveData() {
            if (!selectedDateStr) return alert('日付を選んでね');
            const content = document.getElementById('diary-input').value;
            if (!content) return alert('内容を入力してね');
            const newItem = { category: document.getElementById('category-input').value, event: document.getElementById('event-input').value, text: content };
            const docRef = doc(db, "diaries", selectedDateStr);
            const docSnap = await getDoc(docRef);
            let items = docSnap.exists() ? docSnap.data().items : [];
            items.push(newItem);
            await setDoc(docRef, { items: items });
            document.getElementById('diary-input').value = '';
            renderView();
            alert('同期保存しました！');
        }

        async function deleteItem(date, index) {
            if (!confirm('削除しますか？')) return;
            const docRef = doc(db, "diaries", date);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                let items = docSnap.data().items;
                items.splice(index, 1);
                if (items.length === 0) await deleteDoc(docRef);
                else await setDoc(docRef, { items: items });
                renderView();
            }
        }

        window.changeMonth = (diff) => { currentViewDate.setMonth(currentViewDate.getMonth() + diff); renderView(); };
        window.saveData = saveData;
        window.deleteItem = deleteItem;
        window.renderView = renderView;
        window.downloadBackup = downloadBackup;

        renderView();
    </script>

    <style>
        /* スタイルはそのまま */
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; background: #fdf6f0; color: #444; padding-bottom: 50px; margin: 0; }
        .calendar-header { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 15px 0; width: 100%; }
        .nav-btn { background: #d88a8a; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; }
        h2 { color: #d88a8a; margin: 0; font-size: 1.2rem; text-align: center; }
        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; max-width: 450px; width: 92%; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .weekday { text-align: center; font-size: 12px; font-weight: bold; color: #999; padding: 5px 0; }
        .day { aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; border: 1px solid #f0f0f0; background: #fff; position: relative; }
        .sun, .holiday { color: #ff4d4d !important; background: #fff5f5; }
        .sat { color: #4d79ff; background: #f5f7ff; }
        .today { border: 2px solid #d88a8a !important; font-weight: bold; }
        .selected { background: #fff0f0; border: 2px solid #d88a8a !important; }
        .mark-any { width: 5px; height: 5px; background: #d88a8a; border-radius: 50%; margin-top: 2px; }
        #editor-area { margin-top: 20px; width: 92%; max-width: 450px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); box-sizing: border-box; }
        select, textarea { width: 100%; border-radius: 8px; border: 1px solid #ddd; padding: 12px; box-sizing: border-box; font-size: 16px; margin-bottom: 15px; background-color: #fcfcfc; }
        textarea { height: 100px; resize: none; }
        .save-btn { background: #d88a8a; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .backup-btn { background: #888; color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; font-size: 14px; cursor: pointer; }
        .section-title { width: 92%; max-width: 450px; color: #d88a8a; margin-top: 30px; }
        .filter-group { display: flex; gap: 8px; width: 92%; max-width: 450px; margin-bottom: 15px; }
        .list-container { width: 92%; max-width: 450px; min-height: 100px; }
        .history-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-left: 5px solid #d88a8a; position: relative; }
        .history-header { display: flex; flex-direction: column; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; }
        .history-date { font-weight: bold; font-size: 14px; color: #d88a8a; }
        .history-content { font-size: 15px; white-space: pre-wrap; line-height: 1.5; }
        .delete-btn { position: absolute; top: 12px; right: 12px; background: none; border: none; color: #ddd; cursor: pointer; font-
